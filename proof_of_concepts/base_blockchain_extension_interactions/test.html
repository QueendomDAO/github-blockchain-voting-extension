<!DOCTYPE html>
<html>

<body>

    <h1 id="text">Counter state</h1>
    <button id="btn-add-poll">Add new poll</button>
    <button id="btn-gen-keys">Generate keys</button>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script>

        /* -------------------------------------------------------------------------------------------
        *                                   env settings
        ------------------------------------------------------------------------------------------- */
        var public_address = '0x28CfbA097FF9bb9D904471c493b032Df45B9f953';
        var private_key = 'f1d57d756f7a47c3e70b740acf95b38611a26b81c7a0cff7de872ab306ae35d0';
        var provider = 'https://sokol.poa.network';
        //var contract_address = '0x5C033433987134017A9b7a42673F6A62d673Df3b';
        var contract_address = '0xaa857387aca2a3EE8DA8A7bab79D6f5abD83E548';
        var github_token = '';

        var contract_polls = [];
        var starred_repos = [];
        var pull_requests = [];
        var pollable_pqs = [];
        var username = "SerQuicky";

        var contract_abi = [
            {
                "inputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "constant": true,
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "polls",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "rpId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "pqId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "pqLink",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "pqTitle",
                        "type": "string"
                    },
                    {
                        "internalType": "uint256",
                        "name": "proVotes",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "contraVotes",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "time",
                        "type": "string"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": false,
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_rpId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_pqId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "_pqLink",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "_pqTitle",
                        "type": "string"
                    }
                ],
                "name": "addNewPoll",
                "outputs": [],
                "payable": false,
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "getPollsLength",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "payable": false,
                "stateMutability": "view",
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [],
                "name": "helloWorld",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "payable": false,
                "stateMutability": "pure",
                "type": "function"
            }
        ];

        /* -------------------------------------------------------------------------------------------
        *                                   init web3js
        ------------------------------------------------------------------------------------------- */

        web3 = new Web3(provider);
        contract = new this.web3.eth.Contract(contract_abi, contract_address);
        account = web3.eth.accounts.privateKeyToAccount(private_key);
        web3.eth.getAccounts().then(res => {
            console.log(res);
        });


        getPollNumbers();
        getContractPolls();

        getRequest('https://api.github.com/users/serquicky/starred')
            .then(data => starred_repos = data)
            .catch(error => console.error(error));

        getRequest('https://api.github.com/repos/serquicky/shoe-dataset/pulls')
            .then(data => pull_requests = data)
            .catch(error => console.error(error));

        setTimeout(() => {
            console.log(pull_requests);
            combinePollsAndRepos();
            getPollableRequests();
            console.log("polls", contract_polls);
            console.log("repos", starred_repos);
            console.log("pollable requests", pollable_pqs);
        }, 2000)

        /* -------------------------------------------------------------------------------------------
        *                                   Github calls
        ------------------------------------------------------------------------------------------- */

        function getPollableRequests() {
            for (let i = 0; i < pull_requests.length; i++) {
                let was_found = false;
                let contract_index = 0;
            
                for (let j = 0; j < contract_polls.length; j++) {
                    if(pull_requests[i]['id'] == contract_polls[j][1]) {
                        was_found = true
                        contract_index = j;
                    }
                }

                if(!was_found && pull_requests[i]['state'] == "open") {
                    pollable_pqs.push({pq: pull_requests[i], poll: contract_polls[contract_index]});
                }
            }
        }

        function combinePollsAndRepos() {
            for (let i = 0; i < starred_repos.length; i++) {
                starred_repos[i]['openPolls'] = [];

                for (let j = 0; j < contract_polls.length; j++) {
                    if (starred_repos[i]['id'] == contract_polls[j][0]) {
                        starred_repos[i]['openPolls'].push(contract_polls[j]);
                    }
                }
            }
        }


        function getRequest(url) {
            return fetch(url, {
                method: 'GET', // *GET, POST, PUT, DELETE, etc.
                headers: new Headers({
                    'User-agent': 'Mozilla/4.0 Custom User Agent',
                    "Authorization": "Bearer " + github_token,
                }),
            })
                .then(response => response.json()) //Converting the response to a JSON object
        }


        function getContractPolls() {
            contract.methods.getPollsLength().call().then(async (res) => {
                console.log(res);

                for (let i = 0; i < res; i++) {
                    await contract.methods.polls(i).call().then(poll => {
                        contract_polls.push(poll);
                        console.log(poll);
                    });
                }

            }).catch(err => console.log(err));
        }

        /* -------------------------------------------------------------------------------------------
        *                                   make calls
        ------------------------------------------------------------------------------------------- */

        function getNormalText() {
            contract.methods.helloWorld().call().then(res => {
                console.log(res);
            }).catch(err => console.log(err));
        }

        function getPollNumbers() {
            contract.methods.getPollsLength().call().then(res => {
                document.getElementById("text").innerText = "Number of polls: " + res;
            }).catch(err => console.log(err));
        }

        function genKeys() {
            let acc = web3.eth.accounts.create(web3.utils.randomHex(32));
            let wallet = web3.eth.accounts.wallet.add(acc);
            let keystore = wallet.encrypt(web3.utils.randomHex(32));

            // save adress and private key in the persistant storage
            console.log(acc);
        }

        document.getElementById("btn-add-poll").addEventListener("click", () => {
            addPoll(10, 10, "PQ-Test-URL", "PQ-Test-Name");
        });

        document.getElementById("btn-gen-keys").addEventListener("click", () => {
            genKeys();
        })


        /* -------------------------------------------------------------------------------------------
        *                                   make a transaction
        ------------------------------------------------------------------------------------------- */

        function addPoll(rpId, pqId, pqLink, pqTitle) {
            contract.methods.addNewPoll(rpId, pqId, pqLink, pqTitle).estimateGas({ from: public_address }).then(gas => {

                const tx = {
                    from: public_address,
                    to: contract_address,
                    gas: gas,
                    data: contract.methods.addNewPoll(rpId, pqId, pqLink, pqTitle).encodeABI()
                };

                const signPromise = web3.eth.accounts.signTransaction(tx, private_key);

                signPromise.then((signedTx) => {
                    const sentTx = web3.eth.sendSignedTransaction(signedTx.raw || signedTx.rawTransaction);
                    sentTx.on("receipt", receipt => {
                        console.log(receipt);
                        getPollNumbers()
                    });
                    sentTx.on("error", err => {
                        console.log(err);
                    });
                }).catch(error => console.log(error));
            }).catch(error => console.log(error));
        }


        function sendTest() {
            const tx = {
                from: public_address,
                to: '0xA9126c7dAa5431D2379dEA9e9C3eFc37f35e58AB',
                gas: 1287794,
                value: '1000000000'
            };

            const signPromise = web3.eth.accounts.signTransaction(tx, private_key);

            signPromise.then((signedTx) => {
                const sentTx = web3.eth.sendSignedTransaction(signedTx.raw || signedTx.rawTransaction);
                sentTx.on("receipt", receipt => {
                    console.log(receipt);
                    getCounter()
                });
                sentTx.on("error", err => {
                    console.log(err);
                });
            }).catch(error => console.log(error));
        }




    </script>
</body>

</html>